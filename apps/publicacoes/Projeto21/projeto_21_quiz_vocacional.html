<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Vocacional — Projeto21</title>
  <style>
    :root{
      --bg:#0b1020;--panel:#111831;--muted:#9fb0d9;--text:#e9efff;--accent:#7ea1ff;--ok:#00c27a;--warn:#ffb020;--bad:#ff5d5d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(180deg,#0b1020 0%,#0b132a 60%,#0b1020 100%);color:var(--text)}
    header{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(8px);background:rgba(11,16,32,.7);border-bottom:1px solid rgba(255,255,255,.08);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    h1{margin:0 0 6px;font-size: clamp(20px,4.5vw,30px);letter-spacing:.3px}
    .sub{color:var(--muted);font-size:.95rem}
    main{padding-bottom:60px}

    .controls{display:grid;gap:12px;grid-template-columns:1fr;align-items:end;margin-top:16px}
    @media(min-width:860px){.controls{grid-template-columns:1fr 1fr 1fr 1fr auto auto}}
    label{font-size:.9rem;color:var(--muted)}
    input[type="number"], select, input[type="text"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0f1730;color:var(--text);outline:none}
    input[type="file"]{width:100%}
    .btn{appearance:none;border:none;border-radius:14px;padding:10px 14px;background:var(--accent);color:#091026;font-weight:700;cursor:pointer;box-shadow:0 8px 24px rgba(126,161,255,.25);transition:transform .05s ease}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.16);box-shadow:none}
    .btn.ghost{background:transparent;color:var(--muted);border:none;padding:8px 10px}

    .note{margin-top:10px;color:var(--muted);font-size:.9rem}
    .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:18px}

    .grid{display:grid;gap:14px}
    @media(min-width:860px){.grid{grid-template-columns:repeat(2,1fr)}}

    .qcard{background:#0f1730;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .qhead{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .qnum{font-weight:800;color:var(--accent);font-size:.95rem}
    .qdim{color:var(--muted);font-size:.85rem}
    .qtext{margin:8px 0 10px;line-height:1.4}
    .scale{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .opt{display:flex;align-items:center;gap:6px;justify-content:center;border:1px solid rgba(255,255,255,.12);padding:8px;border-radius:12px}
    .opt input{accent-color:var(--accent)}

    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:16px}
    .inline-help{color:var(--muted);font-size:.9rem}

    .hide{display:none}

    .result{margin-top:22px}
    table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
    th{color:var(--muted);font-weight:600}
    .tag{display:inline-block;background:rgba(126,161,255,.15);border:1px solid rgba(126,161,255,.35);color:#cfe0ff;padding:.1rem .5rem;border-radius:999px;font-size:.8rem}

    .bars{margin-top:14px;display:grid;gap:8px}
    .bar{height:22px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#a7baff);width:0}

    .ok{color:var(--ok)}.warn{color:var(--warn)}.bad{color:var(--bad)}

    @media print{
      header,.controls,.actions .btn.secondary,.actions .btn.ghost,#resultado .actions{display:none!important}
      body{background:white;color:black}
      .panel,.qcard{border-color:#ddd}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Quiz Vocacional — Projeto21</h1>
      <div class="sub">Carregue seu JSON, gere um pacote de 12 questões por grupo e obtenha o resultado automaticamente.</div>
      <div class="controls">
        <div>
          <label>Carregar banco de questões (JSON)</label>
          <input type="file" id="jsonFile" accept="application/json" />
        </div>
        <div>
          <label>Grupo (1–5)</label>
          <select id="grupoSelect">
            <option value="">Selecione…</option>
            <option value="1">Grupo 1</option>
            <option value="2">Grupo 2</option>
            <option value="3">Grupo 3</option>
            <option value="4">Grupo 4</option>
            <option value="5">Grupo 5</option>
          </select>
        </div>
        <div>
          <label>Semente (embaralhamento reprodutível)</label>
          <input type="text" id="seed" placeholder="ex.: turmaA-14ago" />
        </div>
        <div>
          <label>
            <input type="checkbox" id="intercalarPairs" checked /> Intercalar pares (evita itens irmãos consecutivos)
          </label>
        </div>
        <button class="btn" id="btnGerar">Gerar pacote</button>
        <button class="btn secondary" id="btnModelo">Baixar modelo JSON</button>
      </div>
      <div class="note">Dica: salve o progresso — as respostas ficam no seu navegador (localStorage).</div>
    </div>
  </header>

  <main class="wrap">
    <section id="status" class="panel">
      <strong>Status:</strong> <span id="statusText">Aguardando JSON…</span>
    </section>

    <section id="pacote" class="panel hide">
      <h2>Pacote de 12 questões</h2>
      <div class="inline-help">Responda a todas as questões para liberar o resultado.</div>
      <div id="listaQuestoes" class="grid"></div>
      <div class="actions">
        <button class="btn secondary" id="btnSalvar">Salvar progresso</button>
        <button class="btn secondary" id="btnLimpar">Limpar respostas</button>
        <button class="btn" id="btnFinalizar">Finalizar & Ver Resultado</button>
      </div>
    </section>

    <section id="resultado" class="panel hide">
      <h2>Resultado</h2>
      <div id="resumo"></div>
      <div class="bars" id="grafico"></div>
      <div class="result">
        <table id="tabela"></table>
      </div>
      <div class="actions">
        <button class="btn" id="btnBaixarCSV">Baixar resultados (CSV)</button>
        <button class="btn secondary" id="btnBaixarJSON">Baixar resultados (JSON)</button>
        <button class="btn secondary" id="btnImprimir">Imprimir</button>
        <button class="btn ghost" id="btnRefazer">Refazer pacote</button>
      </div>
    </section>

    <section class="panel">
      <details>
        <summary>Como deve ser o arquivo JSON?</summary>
        <p>Estrutura esperada (campos opcionais marcados com *):</p>
<pre style="white-space:pre-wrap;background:#0a132a;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.08)">{
  "meta": {
    "version": 1,
    "escala": [1,2,3,4,5],
    "labels": ["Discordo totalmente","Discordo","Neutro","Concordo","Concordo totalmente"],
    "pares": true
  },
  "dims": {
    "Dimensão 1": {"peso": 1, "descricao": "(edite aqui se quiser)"},
    "Dimensão 2": {"peso": 1}
  },
  "grupos": [
    {
      "id": 1,
      "descricao": "Grupo 1",
      "itens": [
        {"id": "G1-Q01", "texto": "Exemplo de questão.", "dim": "Dimensão 1", "par": 1},
        {"id": "G1-Q02", "texto": "Irmã do par 1.", "dim": "Dimensão 1", "par": 1, "invert": false}
        // … complete até 12 por grupo
      ]
    }
  ]
}</pre>
        <p>Observações:</p>
        <ul>
          <li>O campo <code>par</code> (1..6) identifica pares de itens irmãos; quando <em>Intercalar pares</em> está ativo, o app evita que fiquem colados.</li>
          <li>Use <code>invert: true</code> em itens invertidos (pontuação invertida).</li>
          <li>Se <code>labels</code> ou <code>escala</code> não forem informados, usam-se valores padrão (1..5).</li>
        </ul>
      </details>
    </section>
  </main>

  <script>
  // ====== Utilidades ======
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const state = {
    data:null,
    grupoId:null,
    seed: null,
    pacote: [],
    respostas: {},
    escala:[1,2,3,4,5],
    labels:["Discordo totalmente","Discordo","Neutro","Concordo","Concordo totalmente"]
  };

  function hashStr(str){
    str = String(str ?? "")
    let h = 2166136261 >>> 0;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = (h * 16777619) >>> 0;
    }
    return h;
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function shuffle(arr, seed){
    const rand = mulberry32(seed ?? Math.floor(Math.random()*1e9));
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(rand()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }
  function download(filename, content, mime="application/octet-stream"){ const blob = new Blob([content],{type:mime}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }

  function setStatus(msg){ $('#statusText').textContent = msg; }

  // ====== JSON Modelo ======
  function gerarModeloJSON(){
    const dims = Array.from({length:6}, (_,i)=>`Dimensão ${i+1}`);
    const grupos = [];
    for(let g=1; g<=5; g++){
      const itens=[];
      for(let i=1;i<=12;i++){
        const idx = (i-1)%6; // percorre dimensões
        const par = Math.ceil(i/2); // 1..6
        itens.push({
          id: `G${g}-Q${String(i).padStart(2,'0')}`,
          texto: `Exemplo (G${g}) — questão ${i}. Edite este texto no seu arquivo JSON final.`,
          dim: dims[idx],
          par: par,
          invert: false
        });
      }
      grupos.push({id:g, descricao:`Grupo ${g}`, itens});
    }
    const modelo = {
      meta:{version:1,escala:[1,2,3,4,5],labels:["Discordo totalmente","Discordo","Neutro","Concordo","Concordo totalmente"],pares:true},
      dims: Object.fromEntries(dims.map(d=>[d,{peso:1}])) ,
      grupos
    };
    return JSON.stringify(modelo,null,2);
  }

  // ====== Validação ======
  function validarData(data){
    if(!data || !Array.isArray(data.grupos) || data.grupos.length===0){throw new Error('JSON inválido: faltam grupos.');}
    for(const g of data.grupos){
      if(!g.id) throw new Error('Grupo sem id.');
      if(!Array.isArray(g.itens) || g.itens.length!==12){
        throw new Error(`Grupo ${g.id}: deve ter exatamente 12 itens (encontrado ${g.itens?.length||0}).`);
      }
      g.itens.forEach((q,ix)=>{
        if(!q.id || !q.texto){throw new Error(`Grupo ${g.id}: item ${ix+1} sem id/texto.`)}
      });
    }
  }

  // ====== Intercalar pares ======
  function intercalarPares(itens, seed){
    // Supõe par de 1..6, 12 itens. Intercala primeira passada (um de cada par), depois segunda passada.
    const gruposPar = new Map();
    for(const q of itens){
      const p = q.par ?? null;
      if(!gruposPar.has(p)) gruposPar.set(p,[]);
      gruposPar.get(p).push(q);
    }
    const pares = Array.from(gruposPar.values());
    // Se algum par não tiver exatamente 2, cai no shuffle simples
    if(pares.some(p=>p.length!==2)) return shuffle(itens, seed);

    const ordemPares = shuffle([...pares.keys()], seed);
    const primeira=[], segunda=[];
    for(const idx of ordemPares){
      const [a,b] = pares[idx];
      // Embaralha a ordem a/b com base na semente para variar
      if(seed % 2 === 0){ primeira.push(a); segunda.push(b); } else { primeira.push(b); segunda.push(a); }
    }
    return primeira.concat(segunda);
  }

  // ====== Render ======
  function renderPacote(){
    const lista = $('#listaQuestoes');
    lista.innerHTML='';
    const {pacote, escala, labels} = state;
    pacote.forEach((q, i)=>{
      const card = document.createElement('div'); card.className='qcard';
      card.innerHTML = `
        <div class="qhead">
          <div class="qnum">#${String(i+1).padStart(2,'0')}</div>
          <div class="qdim"><span class="tag">${q.dim || '—'}</span></div>
        </div>
        <div class="qtext">${q.texto}</div>
        <div class="scale" role="radiogroup" aria-label="Escala de resposta">
          ${escala.map((v,idx)=>{
            const name = `q_${q.id}`;
            const checked = state.respostas[q.id]===v ? 'checked' : '';
            const lab = labels[idx] ?? v;
            return `<label class="opt"><input type="radio" name="${name}" value="${v}" ${checked} required><span>${lab}</span></label>`;
          }).join('')}
        </div>`;
      lista.appendChild(card);
    });
    $('#pacote').classList.remove('hide');
    $('#resultado').classList.add('hide');
  }

  function coletarRespostas(){
    const respostas = {};
    for(const q of state.pacote){
      const sel = document.querySelector(`input[name="q_${q.id}"]:checked`);
      if(!sel) return null;
      respostas[q.id] = Number(sel.value);
    }
    return respostas;
  }

  function calcularResultado(){
    const dmeta = state.data.meta || {};
    const dimsPeso = state.data.dims || {};
    const byDim = new Map();
    const maxVal = Math.max(...state.escala);
    for(const q of state.pacote){
      const raw = state.respostas[q.id];
      const val = (q.invert? (maxVal + 1 - raw) : raw);
      const dim = q.dim || 'Sem dimensão';
      const peso = (dimsPeso[dim]?.peso ?? 1);
      const acc = byDim.get(dim) || {soma:0, n:0, max:0};
      acc.soma += val * peso; acc.n += 1; acc.max += maxVal * peso; byDim.set(dim, acc);
    }
    const linhas = [];
    for(const [dim,acc] of byDim){
      const pct = acc.max ? Math.round((acc.soma/acc.max)*100) : 0;
      linhas.push({dim, soma:acc.soma, max:acc.max, pct});
    }
    // Ordena desc por pct
    linhas.sort((a,b)=>b.pct - a.pct);
    return linhas;
  }

  function renderResultado(){
    const linhas = calcularResultado();
    const totalPct = Math.round(linhas.reduce((s,l)=>s+l.pct,0)/Math.max(1,linhas.length));
    const desempenho = totalPct>=80? 'ok' : totalPct>=60? 'warn' : 'bad';
    $('#resumo').innerHTML = `Pontuação média: <strong class="${desempenho}">${totalPct}%</strong>`;

    // Gráfico simples
    const g = $('#grafico'); g.innerHTML='';
    for(const l of linhas){
      const row = document.createElement('div'); row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin:0 4px 4px"><span class="tag">${l.dim}</span><span>${l.pct}%</span></div><div class="bar"><span style="width:${l.pct}%"></span></div>`; g.appendChild(row);
    }

    // Tabela
    const t = $('#tabela');
    t.innerHTML = `<thead><tr><th>Dimensão</th><th>Soma</th><th>Máx.</th><th>%</th></tr></thead>`;
    const tb = document.createElement('tbody');
    for(const l of linhas){
      const tr = document.createElement('tr'); tr.innerHTML = `<td>${l.dim}</td><td>${l.soma}</td><td>${l.max}</td><td>${l.pct}%</td>`; tb.appendChild(tr);
    }
    t.appendChild(tb);

    $('#resultado').classList.remove('hide');
    window.scrollTo({top: $('#resultado').offsetTop-16, behavior:'smooth'});
  }

  function salvarLocal(){
    const payload = {
      data: state.data,
      grupoId: state.grupoId,
      seed: state.seed,
      pacote: state.pacote,
      respostas: state.respostas,
      escala: state.escala,
      labels: state.labels,
      ts: Date.now()
    };
    localStorage.setItem('Projeto21QuizState', JSON.stringify(payload));
    setStatus('Progresso salvo localmente.');
  }
  function restaurarLocal(){
    const raw = localStorage.getItem('Projeto21QuizState');
    if(!raw) return false;
    try{
      const p = JSON.parse(raw);
      state.data=p.data; state.grupoId=p.grupoId; state.seed=p.seed; state.pacote=p.pacote||[]; state.respostas=p.respostas||{}; state.escala=p.escala||state.escala; state.labels=p.labels||state.labels;
      if(state.data){ setStatus('JSON restaurado do armazenamento local.'); $('#pacote').classList.toggle('hide', state.pacote.length===0); if(state.pacote.length) renderPacote(); return true; }
    }catch(e){ /* ignore */ }
    return false;
  }

  // ====== Eventos ======
  $('#jsonFile').addEventListener('change', async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      validarData(data);
      state.data = data;
      if(Array.isArray(data.meta?.escala)) state.escala = data.meta.escala;
      if(Array.isArray(data.meta?.labels)) state.labels = data.meta.labels;
      setStatus(`JSON carregado com sucesso. ${data.grupos.length} grupos.`);
      $('#pacote').classList.add('hide');
      $('#resultado').classList.add('hide');
    }catch(err){
      console.error(err); setStatus('Erro ao carregar JSON: '+ err.message);
    }
  });

  $('#btnModelo').addEventListener('click', ()=>{
    const modelo = gerarModeloJSON();
    download('Projeto21_quiz_modelo.json', modelo, 'application/json');
  });

  $('#btnGerar').addEventListener('click', ()=>{
    if(!state.data){ setStatus('Carregue um JSON primeiro.'); return; }
    const gVal = Number($('#grupoSelect').value);
    if(!gVal){ setStatus('Selecione um grupo (1–5).'); return; }
    const seedStr = ($('#seed').value || (Date.now().toString()));
    const seed = hashStr(seedStr) ^ gVal;

    const grupo = state.data.grupos.find(g=>Number(g.id)===gVal);
    if(!grupo){ setStatus('Grupo não encontrado no JSON.'); return; }

    const itens = grupo.itens.slice();
    const intercalar = $('#intercalarPairs').checked && (state.data.meta?.pares!==false);
    const ordenados = intercalar ? intercalarPares(itens, seed) : shuffle(itens, seed);

    state.grupoId = gVal; state.seed=seed; state.pacote=ordenados; state.respostas={};
    renderPacote(); salvarLocal(); setStatus(`Pacote do Grupo ${gVal} gerado com semente “${seedStr}”.`);
  });

  $('#btnSalvar').addEventListener('click', ()=>{
    const r = coletarRespostas(); if(r){ state.respostas = r; salvarLocal(); }
    else setStatus('Responda todas as questões antes de salvar.');
  });

  $('#btnLimpar').addEventListener('click', ()=>{
    if(!confirm('Limpar todas as respostas deste pacote?')) return;
    state.respostas={}; renderPacote(); salvarLocal();
  });

  $('#btnFinalizar').addEventListener('click', ()=>{
    const r = coletarRespostas(); if(!r){ setStatus('Existem questões sem resposta.'); return; }
    state.respostas = r; salvarLocal(); renderResultado();
  });

  $('#btnBaixarCSV').addEventListener('click', ()=>{
    const linhas = ['timestamp,grupo,pergunta_id,dim,valor,invertido'];
    const ts = new Date().toISOString();
    for(const q of state.pacote){
      const v = state.respostas[q.id];
      const inv = !!q.invert;
      linhas.push([ts, state.grupoId, q.id, JSON.stringify(q.dim||''), v, inv].join(','));
    }
    download(`resultado_G${state.grupoId}.csv`, linhas.join('\n'), 'text/csv');
  });

  $('#btnBaixarJSON').addEventListener('click', ()=>{
    const payload = { timestamp:new Date().toISOString(), grupo: state.grupoId, respostas: state.respostas, seed: state.seed };
    download(`resultado_G${state.grupoId}.json`, JSON.stringify(payload,null,2), 'application/json');
  });

  $('#btnImprimir').addEventListener('click', ()=> window.print());
  $('#btnRefazer').addEventListener('click', ()=>{ $('#resultado').classList.add('hide'); $('#pacote').classList.remove('hide'); window.scrollTo({top: $('#pacote').offsetTop-16, behavior:'smooth'}); });

  // Restaurar se houver
  restaurarLocal();
  </script>
</body>
</html>
